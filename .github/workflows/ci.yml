name: CI - PR & Merge Analysis

on:
  pull_request:
    branches: [main, master, dev]
  push:
    branches: [main, master, dev]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # Ví dụ cho project Node.js (bạn có thể xoá hoặc chỉnh nếu dùng tech khác)
      - name: Setup Node (nếu có dùng Node)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
        if: hashFiles('**/package.json') != ''

      - name: Install dependencies (Node)
        if: hashFiles('**/package.json') != ''
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            npm install -g pnpm
            pnpm install
          elif [ -f yarn.lock ]; then
            npm install -g yarn
            yarn install
          else
            npm install
          fi

      - name: Run lint & test (Node) - chỉnh lệnh theo project của bạn
        if: hashFiles('**/package.json') != ''
        run: |
          if npm run | grep -q "lint"; then
            npm run lint
          else
            echo "Không có script lint, bỏ qua bước lint"
          fi

          if npm run | grep -q "test"; then
            npm test
          else
            echo "Không có script test, bỏ qua bước test"
          fi

      # Bước phân tích generic (bạn có thể đổi thành build, sonar, dotnet test, mvn test, v.v.)
      - name: Custom analysis / build
        run: |
          echo "Thêm lệnh phân tích/builđ của project bạn tại đây."
          echo "Ví dụ:"
          echo "- .NET: dotnet restore && dotnet test"
          echo "- Java: mvn clean verify"
          echo "- Python: pip install -r requirements.txt && pytest"

  notify-discord:
    needs: analyze
    runs-on: ubuntu-latest
    if: always() # Chạy dù CI pass hay fail
    steps:
      - name: Send Discord Notification
        if: secrets.DISCORD_WEBHOOK != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Xác định trạng thái
          ANALYZE_STATUS="${{ needs.analyze.result }}"
          if [ "$ANALYZE_STATUS" = "success" ]; then
            COLOR="3066993"
            EMOJI="✅"
            STATUS_TEXT="**PASSED** - Tất cả kiểm tra đã thành công"
          else
            COLOR="15158332"
            EMOJI="❌"
            STATUS_TEXT="**FAILED** - Có lỗi trong quá trình phân tích"
          fi

          # Lấy thông tin PR hoặc Push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_SOURCE_BRANCH="${{ github.head_ref }}"
            PR_TARGET_BRANCH="${{ github.base_ref }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            EVENT_TYPE="Pull Request"
            EVENT_DETAIL="PR #${PR_NUMBER} → \`${PR_TARGET_BRANCH}\`"
            BRANCH_INFO="Source: \`${PR_SOURCE_BRANCH}\` → Target: \`${PR_TARGET_BRANCH}\`"
          else
            PR_TITLE="Push to ${{ github.ref_name }}"
            PR_AUTHOR="${{ github.actor }}"
            PR_SOURCE_BRANCH="${{ github.ref_name }}"
            PR_TARGET_BRANCH="${{ github.ref_name }}"
            PR_URL="${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}"
            PR_NUMBER=""
            EVENT_TYPE="Push"
            EVENT_DETAIL="Push to \`${{ github.ref_name }}\`"
            BRANCH_INFO="Branch: \`${{ github.ref_name }}\`"
          fi

          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"

          # Tạo embed message
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"${EMOJI} ${EVENT_TYPE} Analysis Result\",
                \"description\": \"**${EVENT_DETAIL}**\\n**Title:** ${PR_TITLE}\\n**Author:** ${PR_AUTHOR}\\n**${BRANCH_INFO}**\\n**Status:** ${STATUS_TEXT}\",
                \"color\": ${COLOR},
                \"fields\": [
                  {
                    \"name\": \"Repository\",
                    \"value\": \"[${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Commit\",
                    \"value\": \"[\`${COMMIT_SHORT}\`](${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Workflow Run\",
                    \"value\": \"[View Details](${WORKFLOW_URL})\",
                    \"inline\": true
                  }
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                \"footer\": {
                  \"text\": \"GitHub Actions • ${{ github.workflow }}\",
                  \"icon_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
                },
                \"url\": \"${PR_URL}\"
              }]
            }" \
            "$DISCORD_WEBHOOK" || echo "Failed to send Discord notification"
